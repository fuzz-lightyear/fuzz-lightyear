const fs = require('fs')
const p = require('path')
const crypto = require('crypto')
const mkdirp = require('mkdirp')
const chalk = require('chalk')
const progress = require('cli-progress')
const { exec } = require('child_process')
const { create } = require('../..')
const consts = require('../../consts')

exports.command = 'clean'
exports.desc = 'Remove all untracked failing test cases.'
exports.builder = {
  module: {
    default: p.join(process.cwd(), 'fuzzing.js'),
    alias: 'm',
    description: 'Path to the module to fuzz',
    type: 'string'
  }
}
exports.handler = async function (argv) {
  const userFunctions = require(argv.module)
  const moduleDir = p.dirname(argv.module)

  const failingTestRoot = p.join(moduleDir, 'test', 'autogenerated','failing')
  if (failingTestRoot.indexOf('test/autogenerated/failing') === -1) {
    console.warn(`Failing test dir did not match expected pattern. Not removing: ${failingTestRoot}`)
    return
  }
  await new Promise((resolve, reject) => {
    exec(`git clean -f ${failingTestRoot}`, (err, stdout, stderr) => {
      if (err) return reject(err)
      if (stdout) console.log(stdout)
      if (stderr) console.error(stderr)
      return resolve()
    })
  })
}

